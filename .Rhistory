}
colnames(adj_pvals) <- paste(
colnames(exp_avg_lig),
colnames(exp_avg_rec),
sep = '_')
rownames(adj_pvals) <- apply(
X = var_set,
MARGIN = 1,
FUN = paste,
collapse = '_'
)
}
# Long-form data.table of results
tmp <- expand.grid(rownames(exp_scores),
colnames(exp_scores),
stringsAsFactors = FALSE)
tmp_idents <- strsplit(x = tmp[[1]], split = '_')
tmp_pairs <- strsplit(x = tmp[[2]], split = '_')
ligand_cell <- sapply(X = tmp_idents, FUN = `[[`, 1)
receptor_cell <- sapply(X = tmp_idents, FUN = `[[`, 2)
ligand <- sapply(X = tmp_pairs, FUN = `[[`, 1)
receptor <- sapply(X = tmp_pairs, FUN = `[[`, 2)
cell_pair <- paste(ligand_cell, receptor_cell, sep = '_')
lr_pair <- paste(ligand, receptor, sep = '_')
tmp_scores <- exp_scores %>% reshape2::melt() %>% .[['value']]
tmp_avg_l <- c(exp_avg_lig)
tmp_avg_r <- c(exp_avg_rec)
tmp_pvals <- pvals %>% reshape2::melt() %>% .[['value']]
if(adjust.pval) {
tmp_adj_pvals <- adj_pvals %>% reshape2::melt() %>% .[['value']]
}
tmp_pct <- exp_pct %>% as.matrix()
tmp_pct_l <- c(tmp_pct[index_x, index_l])
tmp_pct_r <- c(tmp_pct[index_y, index_r])
split_var <- NA
if(!is.null(split.by)) {
split_var <- sapply(X = tmp_idents, FUN = `[[`, 3)
split_var <- factor(x = split_var, levels = levels(lr_data[[split.by]]))
cell_prop <- round(prop.table(cell_counts, margin = 1), 3)*100
tmp_count_l <- mapply(
FUN = function(x,y) cell_prop[x,y],
ligand_cell,
split_var
)
tmp_count_r <- mapply(
FUN = function(x,y) cell_prop[x,y],
receptor_cell,
split_var
)
}
# Final result compilation
results <- data.frame(
'Pair_name' = lr_pair,
'Score' = tmp_scores,
'pval' = tmp_pvals,
'adj_pval' = ifelse(test = exists('tmp_adj_pvals'),
yes = tmp_adj_pvals,
no = NA),
'Ligand_cell' = ligand_cell,
'Receptor_cell' = receptor_cell,
'split.by' = split_var,
'Ligand' = ligand,
'Receptor' = receptor,
'Ligand_avgExp' = tmp_avg_l,
'Receptor_avgExp' = tmp_avg_r,
'Ligand_pct' = tmp_pct_l,
'Receptor_pct' = tmp_pct_r,
'Cell_pair' = cell_pair,
'LR_pair' = lr_pair,
stringsAsFactors = FALSE
)
if(!is.null(split.by)) {
results[['Ligand_cell_pct']] <- tmp_count_l
results[['Receptor_cell_pct']] <- tmp_count_r
}
message('Done!')
return(results)
}
test <- StandardLR(
object = tmp,
ref.path = lr_ref,
split.by = 'time',
resample = 100
)
source('D:/SingleCellTools/R/StandardLR.R')
test <- StandardLR(
object = tmp,
ref.path = lr_ref,
split.by = 'time',
resample = 100
)
test
lr_ref <- '../MiamiProject/sci_scRNAseq/ref/fantom_PairsLigRec_mouse.csv'
lr_ref <- read.csv(lr_ref)
lr_ref
lr_ref <- lr_ref[1:50,]
test <- StandardLR(
object = tmp,
ref.path = lr_ref,
split.by = 'time',
resample = 100
)
test <- StandardLR(
object = tmp,
lr.ref = lr_ref,
split.by = 'time',
resample = 100
)
test
test <- StandardLR(
object = tmp,
lr.ref = lr_ref,
split.by = 'time',
resample = 100
)
slot(tmp, 'active.ident')
%>%
`%>%
``
;
v
)
''
fsda
1
>
$
%
^
%
$
%
x
`%>%`
?`%>%`
packageVersion('Seurat')
packageVersion('dplyr')
colnames(test)
slot(tmp,'meta.data')
!!
sd
?`!!`
where()
?where()
source('D:/SingleCellTools/R/StandardLR.R')
packageVersion('dplyr')
getwd()
setwd('..')
install('SingleCellTools')
devtools::install
setwd('SingleCellTools/')
ls
ls
getwd()
setwd('..')
devtools::install('SingleCellToosl')
install.packages('devtools')
devtools::install('SingleCellTo')
devtools::install('SingleCellTools')
source('D:/SingleCellTools/R/StandardLR.R')
devtools::install('SingleCellTools')
install.packages('tibble')
devtools::install('SingleCellTools')
devtools::install('SingleCellTools')
getwd()
setwd('..')
devtools::install('SingleCellTools')
source('D:/SingleCellTools/R/StandardLR.R')
packageVersion('tibble')
devtools::install('SingleCellTools')
devtools::install('SingleCellTools')
install.packages('tibble')
setwd('..')
devtools::install('SingleCellTools')
options(devtools.install.args = "--no-multiarch")
devtools::install('SingleCellTools')
?StandardLR
??StandardLR
library(SingleCellTools)
StandardLR()
require('Seurat')
require('dplyr')
require('tibble')
vascular <- readRDS(file = '../MiamiProject/sci_scRNAseq/data/vascular.rds')
object = vascular
lr.ref = '../MiamiProject/sci_scRNAseq/ref/fantom_PairsLigRec_mouse.csv'
split.by = 'time'
min.pct = 0.1
assay = "RNA"
slot = "data"
resample = 1000
adjust.pval = FALSE
# Data.frame with results and null distribution score values
if (class(lr_data[['active_idents']]) != 'factor') {
stop('Seurat identities must be of class factor.')
}
# 'object' input check
if (class(object) != 'Seurat') {
stop('\"object\" must be of class Seurat')
}
# 'ref.path' or 'lr.ref' check
if (is.null(ref.path) && is.null(lr.ref)) {
stop(strwrap('Must provide either \"ref.path\" (path of LR reference) or
\"lr.ref\" (data.frame of imported LR reference).', prefix = ' '))
}
object = vascular
ref.path = NULL
lr.ref = '../MiamiProject/sci_scRNAseq/ref/fantom_PairsLigRec_mouse.csv'
split.by = NULL
min.pct = 0.1
assay = "RNA"
slot = "data"
resample = 1000
adjust.pval = FALSE
# 'object' input check
if (class(object) != 'Seurat') {
stop('\"object\" must be of class Seurat')
}
# 'ref.path' or 'lr.ref' check
if (is.null(ref.path) && is.null(lr.ref)) {
stop(strwrap('Must provide either \"ref.path\" (path of LR reference) or
\"lr.ref\" (data.frame of imported LR reference).', prefix = ' '))
}
# Load reference csv.
if (!is.null(ref.path)) {
lr.ref <- read.csv(file = ref.path, stringsAsFactors = FALSE)
}
# Check for Pair.Name column. Error if not present.
if (!any(colnames(lr.ref) == 'Pair.Name')) {
stop(strwrap('Ligand-receptor reference list requires a column titled
\"Pair.Name\". Entries in \"Pair.Name\" should be formatted as: [Ligand
gene]_[Receptor gene]. E.g. Apoe_Lrp1"', prefix = ' '))
} else {
pair_column <- which(colnames(lr.ref) == 'Pair.Name')
}
lr.ref
# Load reference csv.
if (!is.null(ref.path)) {
lr.ref <- read.csv(file = ref.path, stringsAsFactors = FALSE)
}
lr.ref
ref.path = '../MiamiProject/sci_scRNAseq/ref/fantom_PairsLigRec_mouse.csv'
lr.ref = NULL
split.by = NULL
min.pct = 0.1
assay = "RNA"
slot = "data"
resample = 1000
adjust.pval = FALSE
# 'object' input check
if (class(object) != 'Seurat') {
stop('\"object\" must be of class Seurat')
}
# 'ref.path' or 'lr.ref' check
if (is.null(ref.path) && is.null(lr.ref)) {
stop(strwrap('Must provide either \"ref.path\" (path of LR reference) or
\"lr.ref\" (data.frame of imported LR reference).', prefix = ' '))
}
# Load reference csv.
if (!is.null(ref.path)) {
lr.ref <- read.csv(file = ref.path, stringsAsFactors = FALSE)
}
# Check for Pair.Name column. Error if not present.
if (!any(colnames(lr.ref) == 'Pair.Name')) {
stop(strwrap('Ligand-receptor reference list requires a column titled
\"Pair.Name\". Entries in \"Pair.Name\" should be formatted as: [Ligand
gene]_[Receptor gene]. E.g. Apoe_Lrp1"', prefix = ' '))
} else {
pair_column <- which(colnames(lr.ref) == 'Pair.Name')
}
message('LR reference has ', nrow(lr.ref), ' rows (LR pairs).')
# Split Pair.Name into ligand and receptor names
tmp <- strsplit(x = lr.ref[['Pair.Name']], split = '_')
ligand_names <- sapply(X = tmp, FUN = `[`, 1)
receptor_names <- sapply(X = tmp, FUN = `[`, 2)
# Retain all ligand-receptor pairs where both gene names are present in the
# gene expression dataset
all_genes <- rownames(slot(object = object[[assay]], 'counts'))
lr.ref <- lr.ref[ligand_names %in% all_genes & receptor_names %in% all_genes,]
if (nrow(lr.ref) == 0) {
stop('No LR pairs were detected in provided Seurat data.')
}
# Get ligands and receptors that were detected in data
tmp <- strsplit(x = lr.ref[['Pair.Name']], split = '_')
ligand_names <- sapply(X = tmp, FUN = `[`, 1)
receptor_names <- sapply(X = tmp, FUN = `[`, 2)
# Message regarding use of seurat identities
tmp_idents <- paste(unique(slot(object = object, name = 'active.ident')),
collapse = ', ')
message(paste0('Using active identities: ', tmp_idents))
# New vector of all genes to retrieve data
retrieve_genes <- union(ligand_names, receptor_names)
active_idents <- slot(
object = object,
name = 'active.ident'
)
# Extract data
Seurat::DefaultAssay(object) <- assay
lr_data <- Seurat::FetchData(
object = object,
vars = c(split.by, retrieve_genes),
slot = slot
)
active_idents <- slot(
object = object,
name = 'active.ident'
)
lr_data <- cbind(active_idents, lr_data)
message('Using expression values for ', ncol(lr_data), ' genes across ',
nrow(lr_data), ' cells.')
# Calculate average/percent expression for each gene, by "split.by" if
# provided.
exp_avg <- lr_data %>%
group_by(active_idents, .add = TRUE)
exp_pct <- lr_data %>%
group_by(active_idents, .add = TRUE)
if (!is.null(split.by)) {
split.by_name <- as.name(split.by)
exp_avg <- exp_avg %>%
group_by(!!split.by_name, .add = TRUE)
exp_pct <- exp_pct %>%
group_by(!!split.by_name, .add = TRUE)
}
exp_avg <- exp_avg %>%
summarise(across(where(is.numeric), .fns = mean))
exp_pct <- exp_pct %>%
summarise(across(where(is.numeric),
.fns = function(x) round(mean(x > 0), 3)))
# Determine which genes meet minimum percent detection threshold
minpct_genes <- sapply(
X = exp_pct[sapply(exp_pct, is.numeric)],
FUN = function(x) any(x > 0)
)
minpct_genes <- names(minpct_genes)[minpct_genes]
lr.ref <- lr.ref[ligand_names %in% minpct_genes &
receptor_names %in% minpct_genes,]
lr_genes <- sort(unique(minpct_genes))
# Table of cell counts, further split if "split.by" provided.
if (!is.null(split.by)) {
cell_counts <- table(
slot(object = object, name = 'active.ident'),
slot(object = object, name = 'meta.data')[[split.by]]
)
} else {
cell_counts <- table(slot(object = object, name = 'active.ident'))
}
# Cell-level expression matrix for genes in LR reference
exp_mat <- as.matrix(lr_data[sapply(lr_data, is.numeric)])
# Cell-level expression matrix for genes in LR reference
exp_mat <- as.matrix(lr_data[sapply(lr_data, is.numeric)])
# Extract ligand/receptor gene names + expression matrices
tmp <- strsplit(x = lr.ref[['Pair.Name']], split = '_')
ligand_names <- sapply(X = tmp, FUN = `[`, 1)
receptor_names <- sapply(X = tmp, FUN = `[`, 2)
exp_mat_ligands <- exp_mat[,match(ligand_names, colnames(exp_mat))]
exp_mat_receptors <- exp_mat[,match(receptor_names, colnames(exp_mat))]
# Data.frame with results and null distribution score values
if (class(lr_data[['active_idents']]) != 'factor') {
stop('Seurat identities must be of class factor.')
}
if (!is.null(split.by)) {
var_set <- expand.grid(levels(lr_data[['active_idents']]),
levels(lr_data[['active_idents']]),
levels(lr_data[[split.by]]))
colnames(var_set) <- c('Ligand_cell', 'Receptor_cell', 'split.by')
} else {
var_set <- expand.grid(levels(lr_data[['active_idents']]),
levels(lr_data[['active_idents']]))
colnames(var_set) <- c('Ligand_cell', 'Receptor_cell')
}
null_scores <- vector(mode = 'list', length = nrow(var_set))
names(null_scores) <- apply(
X = var_set,
MARGIN = 1,
FUN = paste,
collapse = '_'
)
# Use maxT method for multiple hypotheses p-value adjustment
# (Benjamini-Hochberg appears too hard for 1000x permutations)
if (adjust.pval) {
maxT_scores <- matrix(0, nrow = resample, ncol = nrow(lr.ref))
colnames(maxT_scores) <- paste(colnames(exp_mat_ligands),
colnames(exp_mat_receptors),
sep = '_')
}
var_set
class(lr_data)
object = vascular
ref.path = '../MiamiProject/sci_scRNAseq/ref/fantom_PairsLigRec_mouse.csv'
lr.ref = NULL
split.by = NULL
min.pct = 0.1
assay = "RNA"
slot = "data"
resample = 1000
adjust.pval = FALSE
# 'object' input check
if (class(object) != 'Seurat') {
stop('\"object\" must be of class Seurat')
}
# 'ref.path' or 'lr.ref' check
if (is.null(ref.path) && is.null(lr.ref)) {
stop(strwrap('Must provide either \"ref.path\" (path of LR reference) or
\"lr.ref\" (data.frame of imported LR reference).', prefix = ' '))
}
# Load reference csv.
if (!is.null(ref.path)) {
lr.ref <- read.csv(file = ref.path, stringsAsFactors = FALSE)
}
require('data.table')
lr.ref <- as.data.table(read.csv(file = ref.path, stringsAsFactors = FALSE))
lr.ref
# Check for Pair.Name column. Error if not present.
if (!any(colnames(lr.ref) == 'Pair.Name')) {
stop(strwrap('Ligand-receptor reference list requires a column titled
\"Pair.Name\". Entries in \"Pair.Name\" should be formatted as: [Ligand
gene]_[Receptor gene]. E.g. Apoe_Lrp1"', prefix = ' '))
} else {
pair_column <- which(colnames(lr.ref) == 'Pair.Name')
}
pair_column
message('LR reference has ', nrow(lr.ref), ' rows (LR pairs).')
# Split Pair.Name into ligand and receptor names
tmp <- strsplit(x = lr.ref[['Pair.Name']], split = '_')
ligand_names <- sapply(X = tmp, FUN = `[`, 1)
receptor_names <- sapply(X = tmp, FUN = `[`, 2)
# Retain all ligand-receptor pairs where both gene names are present in the
# gene expression dataset
all_genes <- rownames(slot(object = object[[assay]], 'counts'))
lr.ref <- lr.ref[ligand_names %in% all_genes & receptor_names %in% all_genes,]
lr.ref
class(lr.ref)
if (nrow(lr.ref) == 0) {
stop('No LR pairs were detected in provided Seurat data.')
}
# Get ligands and receptors that were detected in data
tmp <- strsplit(x = lr.ref[['Pair.Name']], split = '_')
ligand_names <- sapply(X = tmp, FUN = `[`, 1)
receptor_names <- sapply(X = tmp, FUN = `[`, 2)
# Message regarding use of seurat identities
tmp_idents <- paste(unique(slot(object = object, name = 'active.ident')),
collapse = ', ')
message(paste0('Using active identities: ', tmp_idents))
# New vector of all genes to retrieve data
retrieve_genes <- union(ligand_names, receptor_names)
active_idents <- slot(
object = object,
name = 'active.ident'
)
# Extract data
Seurat::DefaultAssay(object) <- assay
lr_data <- Seurat::FetchData(
object = object,
vars = c(split.by, retrieve_genes),
slot = slot
)
class(lr_data)
lr_data
rownames(lr_data)
?as.data.table()
lr_data <- as.data.table(
x = Seurat::FetchData(
object = object,
vars = c(split.by, retrieve_genes),
slot = slot
),
keep.rownames = TRUE,
na.rm = FALSE
)
lr_data
class(lr_data)
active_idents <- slot(
object = object,
name = 'active.ident'
)
active-i
lr_data <- cbind(active_idents, lr_data)
class(lr_data)
message('Using expression values for ', ncol(lr_data), ' genes across ',
nrow(lr_data), ' cells.')
library('Matrix')
library('Seurat')
getwd()
Matrix::readMM(file = 'C:/Users/JSC_PC/Downloads/GSE162610_sci_mat.mtx/GSE162610_sci_mat.mtx')
test <- Matrix::readMM(file = 'C:/Users/JSC_PC/Downloads/GSE162610_sci_mat.mtx/GSE162610_sci_mat.mtx')
writeMM
?writeMM
sci <- readRDS("D:/MiamiProject/sci_scRNAseq/data/sci.rds")
class(sci[['RNA']]@counts)
sci <- sci[['RNA']]@counts
gc()
test <- Matrix::readMM(file = 'C:/Users/JSC_PC/Downloads/GSE162610_sci_mat.mtx/GSE162610_sci_mat.mtx')
?readMM()
dim(sci)
test <- Matrix::readMM(file = 'D:/MiamiProject/sci_scRNAseq/data/GEO_submission/sci_mat.mtx')
dim(test)
test[1,]
test[1,] == sci[1,]
test2 <- Matrix::readMM(file = 'C:/Users/JSC_PC/Downloads/GSE162610_sci_mat.mtx/GSE162610_sci_mat.mtx')
test2 <- readLines(file = 'C:/Users/JSC_PC/Downloads/GSE162610_sci_mat.mtx/GSE162610_sci_mat.mtx')
test2 <- readLines('C:/Users/JSC_PC/Downloads/GSE162610_sci_mat.mtx/GSE162610_sci_mat.mtx')
test2
head(test2)
test2 <- readMM('C:/Users/JSC_PC/Downloads/GSE162610_sci_mat.mtx/GSE162610_sci_mat.mtx')
test2 <- readLines('C:/Users/JSC_PC/Downloads/GSE162610_sci_mat.mtx/GSE162610_sci_mat.mtx')
test2
dim(test2)
?writeMM
writeMM(obj = sci, file = 'D:/MiamiProject/sci_scRNAseq/data/GEO_submission/sci_mat2.mtx')
test2 <- readMM('D:/MiamiProject/sci_scRNAseq/data/GEO_submission/test/sci_mat2.mtx')
rm(list = ls())
gc()
